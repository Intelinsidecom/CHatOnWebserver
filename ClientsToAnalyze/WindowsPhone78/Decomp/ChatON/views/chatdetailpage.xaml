<phone:PhoneApplicationPage
    x:Class="ChatOn.Views.ChatDetailPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:phone="clr-namespace:Microsoft.Phone.Controls;assembly=Microsoft.Phone"
    xmlns:shell="clr-namespace:Microsoft.Phone.Shell;assembly=Microsoft.Phone"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:Customcontrols="clr-namespace:ChatOn.Controls"
    xmlns:toolkit="clr-namespace:Microsoft.Phone.Controls;assembly=Microsoft.Phone.Controls.Toolkit"
    FontFamily="{StaticResource PhoneFontFamilyNormal}"
    FontSize="{StaticResource PhoneFontSizeNormal}"
    SupportedOrientations="PortraitOrLandscape" Orientation="Portrait"
    mc:Ignorable="d" d:DesignHeight="696" d:DesignWidth="480"
    shell:SystemTray.IsVisible="True"
    toolkit:TiltEffect.IsTiltEnabled="True" Background="{x:Null}">

    <phone:PhoneApplicationPage.Resources>
        <ControlTemplate x:Key="PhoneProgressBarSliderThumb" TargetType="Thumb">
            <Rectangle Fill="{TemplateBinding Foreground}" Height="4" IsHitTestVisible="False" Width="4"/>
        </ControlTemplate>
        <Style x:Key="PhoneProgressBarSliderStyle" TargetType="Slider">
            <Setter Property="Maximum" Value="3000"/>
            <Setter Property="Minimum" Value="0"/>
            <Setter Property="Value" Value="0"/>
            <Setter Property="Opacity" Value="0"/>
            <Setter Property="IsTabStop" Value="False"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Slider">
                        <Grid IsHitTestVisible="False">
                            <Grid x:Name="HorizontalTemplate">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <RepeatButton x:Name="HorizontalTrackLargeChangeDecreaseRepeatButton" Grid.Column="0" Height="0" Template="{x:Null}"/>
                                <Thumb x:Name="HorizontalThumb" Grid.Column="1" Foreground="{TemplateBinding Foreground}" Height="4" IsTabStop="False" Template="{StaticResource PhoneProgressBarSliderThumb}"/>
                                <RepeatButton x:Name="HorizontalTrackLargeChangeIncreaseRepeatButton" Grid.Column="2" Height="0" Template="{x:Null}"/>
                            </Grid>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="ProgressBarStyle1" TargetType="ProgressBar">
            <Setter Property="Foreground" Value="{StaticResource PhoneAccentBrush}"/>
            <Setter Property="Background" Value="Black"/>
            <Setter Property="Maximum" Value="100"/>
            <Setter Property="IsHitTestVisible" Value="False"/>
            <Setter Property="Padding" Value="{StaticResource PhoneHorizontalMargin}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ProgressBar">
                        <Grid>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Determinate"/>
                                    <VisualState x:Name="Indeterminate">
                                        <Storyboard Duration="00:00:04.4" RepeatBehavior="Forever">
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetProperty="Visibility" Storyboard.TargetName="IndeterminateRoot">
                                                <DiscreteObjectKeyFrame KeyTime="0">
                                                    <DiscreteObjectKeyFrame.Value>
                                                        <Visibility>Visible</Visibility>
                                                    </DiscreteObjectKeyFrame.Value>
                                                </DiscreteObjectKeyFrame>
                                            </ObjectAnimationUsingKeyFrames>
                                            <ObjectAnimationUsingKeyFrames Storyboard.TargetProperty="Visibility" Storyboard.TargetName="DeterminateRoot">
                                                <DiscreteObjectKeyFrame KeyTime="0">
                                                    <DiscreteObjectKeyFrame.Value>
                                                        <Visibility>Collapsed</Visibility>
                                                    </DiscreteObjectKeyFrame.Value>
                                                </DiscreteObjectKeyFrame>
                                            </ObjectAnimationUsingKeyFrames>
                                            <DoubleAnimationUsingKeyFrames Storyboard.TargetProperty="Value" Storyboard.TargetName="Slider1">
                                                <EasingDoubleKeyFrame KeyTime="00:00:00.5" Value="1000">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <ExponentialEase EasingMode="EaseOut" Exponent="1"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                                <LinearDoubleKeyFrame KeyTime="00:00:02.0" Value="2000"/>
                                                <EasingDoubleKeyFrame KeyTime="00:00:02.5" Value="3000">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <ExponentialEase EasingMode="EaseIn" Exponent="1"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                            </DoubleAnimationUsingKeyFrames>
                                            <DoubleAnimationUsingKeyFrames BeginTime="00:00:00.2" Storyboard.TargetProperty="Value" Storyboard.TargetName="Slider2">
                                                <EasingDoubleKeyFrame KeyTime="00:00:00.5" Value="1000">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <ExponentialEase EasingMode="EaseOut" Exponent="1"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                                <LinearDoubleKeyFrame KeyTime="00:00:02.0" Value="2000"/>
                                                <EasingDoubleKeyFrame KeyTime="00:00:02.5" Value="3000">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <ExponentialEase EasingMode="EaseIn" Exponent="1"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                            </DoubleAnimationUsingKeyFrames>
                                            <DoubleAnimationUsingKeyFrames BeginTime="00:00:00.4" Storyboard.TargetProperty="Value" Storyboard.TargetName="Slider3">
                                                <EasingDoubleKeyFrame KeyTime="00:00:00.5" Value="1000">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <ExponentialEase EasingMode="EaseOut" Exponent="1"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                                <LinearDoubleKeyFrame KeyTime="00:00:02.0" Value="2000"/>
                                                <EasingDoubleKeyFrame KeyTime="00:00:02.5" Value="3000">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <ExponentialEase EasingMode="EaseIn" Exponent="1"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                            </DoubleAnimationUsingKeyFrames>
                                            <DoubleAnimationUsingKeyFrames BeginTime="00:00:00.6" Storyboard.TargetProperty="Value" Storyboard.TargetName="Slider4">
                                                <EasingDoubleKeyFrame KeyTime="00:00:00.5" Value="1000">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <ExponentialEase EasingMode="EaseOut" Exponent="1"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                                <LinearDoubleKeyFrame KeyTime="00:00:02.0" Value="2000"/>
                                                <EasingDoubleKeyFrame KeyTime="00:00:02.5" Value="3000">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <ExponentialEase EasingMode="EaseIn" Exponent="1"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                            </DoubleAnimationUsingKeyFrames>
                                            <DoubleAnimationUsingKeyFrames BeginTime="00:00:00.8" Storyboard.TargetProperty="Value" Storyboard.TargetName="Slider5">
                                                <EasingDoubleKeyFrame KeyTime="00:00:00.5" Value="1000">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <ExponentialEase EasingMode="EaseOut" Exponent="1"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                                <LinearDoubleKeyFrame KeyTime="00:00:02.0" Value="2000"/>
                                                <EasingDoubleKeyFrame KeyTime="00:00:02.5" Value="3000">
                                                    <EasingDoubleKeyFrame.EasingFunction>
                                                        <ExponentialEase EasingMode="EaseIn" Exponent="1"/>
                                                    </EasingDoubleKeyFrame.EasingFunction>
                                                </EasingDoubleKeyFrame>
                                            </DoubleAnimationUsingKeyFrames>
                                            <DoubleAnimationUsingKeyFrames Storyboard.TargetProperty="Opacity" Storyboard.TargetName="Slider1">
                                                <DiscreteDoubleKeyFrame KeyTime="0" Value="1"/>
                                                <DiscreteDoubleKeyFrame KeyTime="00:00:02.5" Value="0"/>
                                            </DoubleAnimationUsingKeyFrames>
                                            <DoubleAnimationUsingKeyFrames BeginTime="00:00:00.2" Storyboard.TargetProperty="Opacity" Storyboard.TargetName="Slider2">
                                                <DiscreteDoubleKeyFrame KeyTime="0" Value="1"/>
                                                <DiscreteDoubleKeyFrame KeyTime="00:00:02.5" Value="0"/>
                                            </DoubleAnimationUsingKeyFrames>
                                            <DoubleAnimationUsingKeyFrames BeginTime="00:00:00.4" Storyboard.TargetProperty="Opacity" Storyboard.TargetName="Slider3">
                                                <DiscreteDoubleKeyFrame KeyTime="0" Value="1"/>
                                                <DiscreteDoubleKeyFrame KeyTime="00:00:02.5" Value="0"/>
                                            </DoubleAnimationUsingKeyFrames>
                                            <DoubleAnimationUsingKeyFrames BeginTime="00:00:00.6" Storyboard.TargetProperty="Opacity" Storyboard.TargetName="Slider4">
                                                <DiscreteDoubleKeyFrame KeyTime="0" Value="1"/>
                                                <DiscreteDoubleKeyFrame KeyTime="00:00:02.5" Value="0"/>
                                            </DoubleAnimationUsingKeyFrames>
                                            <DoubleAnimationUsingKeyFrames BeginTime="00:00:00.8" Storyboard.TargetProperty="Opacity" Storyboard.TargetName="Slider5">
                                                <DiscreteDoubleKeyFrame KeyTime="0" Value="1"/>
                                                <DiscreteDoubleKeyFrame KeyTime="00:00:02.5" Value="0"/>
                                            </DoubleAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <Grid x:Name="DeterminateRoot" Margin="{TemplateBinding Padding}" Visibility="Visible">
                                <Rectangle x:Name="ProgressBarTrack" Fill="{TemplateBinding Background}" Height="6" Opacity="0.5"/>
                                <Rectangle x:Name="ProgressBarIndicator" Fill="{TemplateBinding Foreground}" HorizontalAlignment="Left" Height="4" Margin="1,0,1,0"/>
                            </Grid>
                            <Border x:Name="IndeterminateRoot" Margin="{TemplateBinding Padding}" Visibility="Collapsed">
                                <Grid>
                                    <Slider x:Name="Slider1" Foreground="{TemplateBinding Foreground}" Style="{StaticResource PhoneProgressBarSliderStyle}"/>
                                    <Slider x:Name="Slider2" Foreground="{TemplateBinding Foreground}" Style="{StaticResource PhoneProgressBarSliderStyle}"/>
                                    <Slider x:Name="Slider3" Foreground="{TemplateBinding Foreground}" Style="{StaticResource PhoneProgressBarSliderStyle}"/>
                                    <Slider x:Name="Slider4" Foreground="{TemplateBinding Foreground}" Style="{StaticResource PhoneProgressBarSliderStyle}"/>
                                    <Slider x:Name="Slider5" Foreground="{TemplateBinding Foreground}" Style="{StaticResource PhoneProgressBarSliderStyle}"/>
                                </Grid>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <DataTemplate x:Key="DateTemplate">
            <Grid VerticalAlignment="Top" Margin="0,0,0,24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Image Height="32" Source="/ChatOn;component/Images/chat_today.png" Stretch="Fill"/>
                <TextBlock TextWrapping="Wrap" Text="{Binding Time,Converter={StaticResource MiliToChatDetailDateConverter}}" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" FontFamily="Segoe WP Semibold" Foreground="#B2FFFFFF"/>
                <CheckBox Click="DateHeaderCheckBox_Click" Visibility="{Binding ShowCheckbox, Converter={StaticResource BoolToVisibility}}" IsChecked="{Binding IsChecked2,Mode=TwoWay}" Grid.Column="1" HorizontalAlignment="Right" VerticalAlignment="Center"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="BuddyMessageTemplate">
            <Grid VerticalAlignment="Top" Margin="0,0,0,8">
                <Grid.RowDefinitions>
                    <RowDefinition/>
                    <RowDefinition Height="20"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="62"/>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Grid Tag="tilt" Tap="ProfileImage_Tap">
                    <Image x:Name="ProfileImage"
                		Source="{Binding Sender, Converter={StaticResource PhoneNumberToUriConverter}}" Width="58" Height="58" HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="1,0,0,3"/>
                    <Image Visibility="{Binding Sender, Converter={StaticResource PhoneNumberToChatFrameVisibility}}" Source="/ChatOn;component/Images/chat_frame.png" Stretch="Fill" Width="62" Height="62" HorizontalAlignment="Left" VerticalAlignment="Bottom"/>
                </Grid>
                <TextBlock Text="{Binding Sender, Converter={StaticResource PhoneNumberToNameConverter}}" Margin="0" TextWrapping="Wrap" Grid.Row="1" FontSize="16" Foreground="#FF141414" Grid.ColumnSpan="2"/>
                <Customcontrols:ChatBubble Grid.Column="1" Type="0" Tap="Message_Tap" MaxBubbleWidth="{Binding Tag, ElementName=DummyGrid2}"
                                               Message="{Binding}" Text="{Binding Text}" SubTextVisibility="Visible" SubText="{Binding Time, Converter={StaticResource MillisecondsToDate}, ConverterParameter='t'}"
                                               MediaText="{Binding MediaText}" HorizontalContentAlignment="Left" VerticalContentAlignment="Top" HorizontalAlignment="Left" VerticalAlignment="Top"/>
                <Grid x:Name="DummyGrid2" Grid.Column="1" Margin="50, 0, 0, 0" SizeChanged="DummyGrid_SizeChanged"/>
                <ContentControl Visibility="{Binding IsDownloading,Converter={StaticResource BoolToVisibility}}" Grid.Column="2" HorizontalAlignment="Left" VerticalAlignment="Bottom"
                                ContentTemplate="{Binding IsDownloading, Converter={StaticResource BoolToTemplate}, ConverterParameter='DownloadingTemplate'}" 
                                Content="{Binding}"/>
                <CheckBox Click="CheckBox_Click" Visibility="{Binding ShowCheckbox, Converter={StaticResource BoolToVisibility}}" IsChecked="{Binding IsChecked,Mode=TwoWay}" Grid.Column="3" HorizontalAlignment="Right" VerticalAlignment="Center"/>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="DownloadingTemplate">
            <StackPanel>
                <ProgressBar Value="{Binding ProgressValue}" HorizontalAlignment="Center" IsHitTestVisible="False" Width="100" Height="44" SmallChange="1" Style="{StaticResource ProgressBarStyle1}" VerticalAlignment="Center"/>
                <Image Tap="CancelButton_Tap" Source="/ChatOn;component/Images/chat_cancel.png" Stretch="None" VerticalAlignment="Center" HorizontalAlignment="Center"/>
            </StackPanel>
        </DataTemplate>
        <DataTemplate x:Key="SentTemplate">
            <Grid>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="SendingTemplate">
            <Grid VerticalAlignment="Center">
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="UploadingTemplate">
            <StackPanel>
                <ProgressBar Value="{Binding ProgressValue}" HorizontalAlignment="Center" IsHitTestVisible="False" Width="100" Height="44" SmallChange="1" Style="{StaticResource ProgressBarStyle1}" VerticalAlignment="Center"/>
                <Image Tap="CancelSendButton_Tap" Source="/ChatOn;component/Images/chat_cancel.png" Stretch="None" VerticalAlignment="Center" HorizontalAlignment="Center"/>
            </StackPanel>
        </DataTemplate>
        <DataTemplate x:Key="FailedTemplate">
            <StackPanel Orientation="Horizontal" Margin="0,0,15,0" >
                <Image Tap="ReSend_Tap" HorizontalAlignment="Left" Source="/ChatOn;component/Images/chat_resend.png" Stretch="None"/>
                <Image Tap="DeleteMessage_Tap" HorizontalAlignment="Left" Source="/ChatOn;component/Images/chat_cancel.png" Stretch="None" Margin="8,0,0,0"/>
        	</StackPanel>
        </DataTemplate>
        <DataTemplate x:Key="CannotResendTemplate">
            <StackPanel Orientation="Horizontal" Margin="0,0,15,0" >
                <Image Tap="DeleteMessage_Tap" HorizontalAlignment="Left" Source="/ChatOn;component/Images/chat_cancel.png" Stretch="None" Margin="8,0,0,0"/>
            </StackPanel>
        </DataTemplate>
        <DataTemplate x:Key="MyMessageTemplate">
            <Grid VerticalAlignment="Top" Margin="0,0,0,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <ContentControl Content="{Binding}" HorizontalContentAlignment="Right" ContentTemplate="{Binding ActivityState, Converter={StaticResource IndexToTemplate}, ConverterParameter='SendingTemplate,UploadingTemplate,FailedTemplate,FailedTemplate,SentTemplate,CannotResendTemplate,ChatDetailPage'}"/>
                <Customcontrols:ChatBubble Opacity="{Binding ActivityState, Converter={StaticResource MessageStateToOpacity}}" Grid.Column="1" Type="1" HorizontalAlignment="Right" MaxBubbleWidth="{Binding Tag, ElementName=DummyGrid}"
                                           Tap="Message_Tap" Message="{Binding}" Text="{Binding Text}" SubTextVisibility="{Binding ActivityState, Converter={StaticResource MessageStateToSubTextVisibility}}" SubText="{Binding Time, Converter={StaticResource MillisecondsToDate}, ConverterParameter='t'}" SubParam="{Binding AnswerBackCount}" MediaText="{Binding MediaText}"/>
                <Grid x:Name="DummyGrid" Grid.Column="1" Margin="50, 0, 0, 0" SizeChanged="DummyGrid_SizeChanged"/>
                <CheckBox Click="CheckBox_Click" Visibility="{Binding ShowCheckbox, Converter={StaticResource BoolToVisibility}}" IsChecked="{Binding IsChecked,Mode=TwoWay}" Grid.Column="2" HorizontalAlignment="Right" VerticalAlignment="Center"/>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="NotiTemplate">
            <Grid VerticalAlignment="Top" Margin="0,12,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Grid VerticalAlignment="Top" Background="#5E000000" HorizontalAlignment="Left">
                    <TextBlock TextWrapping="Wrap" Text="{Binding Converter={StaticResource NotiToMessageConverter}}" VerticalAlignment="Top" FontSize="16" FontFamily="Segoe WP Semibold" Foreground="#B2FFFFFF" Margin="20,0"/>
                </Grid>
                <CheckBox Click="CheckBox_Click" Visibility="{Binding ShowCheckbox, Converter={StaticResource BoolToVisibility}}" IsChecked="{Binding IsChecked,Mode=TwoWay}" Grid.Column="1" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,-20,0,0"/>
            </Grid>
        </DataTemplate>
        <DataTemplate x:Key="ChatItemTemplate">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <ContentControl Visibility="{Binding ShowDate,Converter={StaticResource BoolToVisibility}}" Grid.Row="0" HorizontalAlignment="Left" VerticalAlignment="Top" 
                                ContentTemplate="{Binding ShowDate, Converter={StaticResource BoolToTemplate}, ConverterParameter='DateTemplate'}" 
                                Content="{Binding}"/>
                <ContentControl Hold="Message_Hold" Grid.Row="1" VerticalAlignment="Top" 
                                ContentTemplate="{Binding ItemTypeValue, Converter={StaticResource IndexToTemplate}, ConverterParameter='DateTemplate,BuddyMessageTemplate,MyMessageTemplate,NotiTemplate,ChatDetailPage'}" 
                                Content="{Binding}" HorizontalContentAlignment="Stretch"/>
            </Grid>
        </DataTemplate>
        <ControlTemplate x:Key="PhoneDisabledTextBoxTemplate" TargetType="TextBox">
            <ContentControl x:Name="ContentElement" BorderThickness="0" HorizontalContentAlignment="Stretch" Margin="{StaticResource PhoneTextBoxInnerMargin}" Padding="{TemplateBinding Padding}" VerticalContentAlignment="Stretch"/>
        </ControlTemplate>
    </phone:PhoneApplicationPage.Resources>
    
    <!--LayoutRoot is the root grid where all page content is placed-->
    <Grid x:Name="LayoutRoot">
        <Grid x:Name="MainGrid">
            <Grid.RowDefinitions>
                <RowDefinition/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Image x:Name="BG" Grid.RowSpan="3" Source="{Binding BackgroundImage}" Stretch="Fill"/>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="72"/>
                    <RowDefinition/>
                </Grid.RowDefinitions>
                <Grid Background="{StaticResource PhoneChromeBrush}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="24"/>
                        <ColumnDefinition/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Grid Grid.Column="1" VerticalAlignment="Top" Margin="0,0,5,0" Tag="tilt" Tap="ChatTitle_Tap">
                    	<Grid.ColumnDefinitions>
                    		<ColumnDefinition/>
                    		<ColumnDefinition Width="Auto"/>
                    	</Grid.ColumnDefinitions>
                        <TextBlock x:Name="TitleTextBlock" TextWrapping="Wrap" FontSize="26" Text="{Binding Chat.Title}" TextTrimming="WordEllipsis"/>
                        <TextBlock TextWrapping="Wrap" FontSize="26" Text="{Binding Chat.MemberCountText}" Visibility="{Binding Chat.MemberCountText, Converter={StaticResource StringNullOrEmptyToHide}}" VerticalAlignment="Bottom" Grid.Column="1" HorizontalAlignment="Right"/>
                    </Grid>
                    <Grid VerticalAlignment="Bottom" Grid.Column="1" Visibility="{Binding Chat.SingleChatBuddy,Converter={StaticResource ObjectNullToHide}}">
                        <TextBlock TextWrapping="NoWrap" TextTrimming="WordEllipsis" Text="{Binding Chat.SingleChatBuddy.Status}" FontSize="24" Height="36"/>
                    </Grid>
                    <Grid Tag="tilt" Visibility="{Binding Chat.ChatType, Converter={StaticResource IntNotEqualToVisibility}, ConverterParameter='2'}" Grid.Column="2" HorizontalAlignment="Right" Margin="0" Tap="Trunk_Tap">
                        <Image Visibility="{StaticResource PhoneDarkThemeVisibility}" HorizontalAlignment="Right" VerticalAlignment="Center" Source="/ChatOn;component/Images/button_trunk.png" Stretch="None" d:LayoutOverrides="HorizontalAlignment" Margin="0,0,24,0"/>
                        <Image Visibility="{StaticResource PhoneLightThemeVisibility}" HorizontalAlignment="Right" VerticalAlignment="Center" Source="/Images/LightTheme/button_trunk.png" Stretch="None" d:LayoutOverrides="HorizontalAlignment" Margin="0,0,24,0"/>
                        <Grid Visibility="{Binding Chat.UnreadTrunkMessageCount, ConverterParameter=0, Converter={StaticResource BiggerThanParamToVisibility}}" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,5,10,0">
                    		<Image Source="/ChatOn;component/Images/bubble_blue.png" Stretch="None" VerticalAlignment="Top" HorizontalAlignment="Left" Margin="0"/>
                    		<TextBlock
                    			TextWrapping="Wrap" FontSize="18" FontFamily="Segoe WP" TextAlignment="Center" HorizontalAlignment="Center" VerticalAlignment="Top" Foreground="#E5FFFFFF" Text="{Binding Chat.UnreadTrunkMessageCount}"/>
                    	</Grid>
                    </Grid>
                </Grid>
                <ListBox x:Name="MessageList" Grid.Row="1" HorizontalContentAlignment="Stretch" ItemTemplate="{StaticResource ChatItemTemplate}"
                     ItemsSource="{Binding Path=MessageItems}" Margin="5,0" ItemContainerStyle="{StaticResource FullWidthListBoxItemStyle}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Loaded="StackPanel_Loaded"></StackPanel>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ListBox>
                <Grid Background="{StaticResource PhoneChromeBrush}" Visibility="{Binding Chat.IsDeletionMode,Converter={StaticResource BoolToVisibility}}" d:IsHidden="True">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <Button Click="SelectAll_Click" Content="{Binding MyResContainer.IDS_CHATON_BODY_ALL, Source={StaticResource LocalizedStrings}}" FontSize="20" Padding="0"/>
                    <Button Click="Received_Click" Content="{Binding MyResContainer.IDS_CHATON_BODY_RECEIVED_ABB, Source={StaticResource LocalizedStrings}}" Grid.Column="1" FontSize="20" Padding="0"/>
                    <Button Click="Sent_Click" Grid.Column="2" FontSize="20" Content="{Binding MyResContainer.IDS_CHATON_BODY_SENT_ABB, Source={StaticResource LocalizedStrings}}" Padding="0"/>
                </Grid>
            </Grid>
            <Customcontrols:EmoticonChooser x:Name="EmoticonPanel" Margin="3,0,3,4"  Visibility="{Binding EmoticonChooserVisibility}"  Grid.Row="1" Completed="EmoticonChooser_Completed" Tap="EmoticonChooser_Tap" Height="70"/>
            <ScrollViewer x:Name="InputScroll" Visibility="{Binding Chat.IsDeletionMode, ConverterParameter=!, Converter={StaticResource BoolToVisibility}}" VerticalAlignment="Bottom" Grid.Row="2" MaxHeight="75" BorderThickness="2" BorderBrush="Black" Margin="24,0,24,4">
            	<ScrollViewer.Background>
            		<SolidColorBrush Color="White"/>
            	</ScrollViewer.Background>
            	<TextBox x:Name="InputBox" InputScope="Chat" GotFocus="InputBox_GotFocus" LostFocus="InputBox_LostFocus" TextWrapping="Wrap" TextChanged="TextBox_TextChanged" FontSize="24" VerticalAlignment="Top" AcceptsReturn="True" MaxHeight="2000" SizeChanged="InputBox_SizeChanged" Margin="-12" BorderThickness="0"/>
            </ScrollViewer>
        </Grid>
    </Grid>

    <!--Sample code showing usage of ApplicationBar-->
    <phone:PhoneApplicationPage.ApplicationBar>
        <shell:ApplicationBar IsVisible="True" IsMenuEnabled="True">
        </shell:ApplicationBar>
    </phone:PhoneApplicationPage.ApplicationBar>

</phone:PhoneApplicationPage>
